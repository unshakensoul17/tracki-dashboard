<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracki Admin Dashboard</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 350px;
      background: #1e293b;
      border-right: 1px solid #334155;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 20px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 15px 20px;
      background: #0f172a;
      border-bottom: 1px solid #334155;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #6366f1;
    }

    .stat-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      margin-top: 5px;
    }

    .device-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .device-item {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .device-item:hover {
      border-color: #6366f1;
      transform: translateY(-2px);
    }

    .device-item.active {
      border-color: #6366f1;
      background: #1e293b;
    }

    .device-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #f1f5f9;
    }

    .device-id {
      font-size: 12px;
      color: #64748b;
      font-family: monospace;
      margin-bottom: 8px;
    }

    .device-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #94a3b8;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .status-dot.offline {
      background: #ef4444;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .device-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn-primary {
      background: #6366f1;
      color: white;
    }

    .btn-primary:hover {
      background: #4f46e5;
    }

    .btn-secondary {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .connection-status {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #334155;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1e293b;
      padding: 30px;
      border-radius: 12px;
      border: 1px solid #334155;
      max-width: 400px;
      width: 90%;
    }

    .modal-title {
      font-size: 20px;
      margin-bottom: 20px;
      color: #f1f5f9;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #94a3b8;
    }

    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #334155;
      border-radius: 6px;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #0f172a;
    }

    .login-box {
      background: #1e293b;
      padding: 40px;
      border-radius: 12px;
      border: 1px solid #334155;
      width: 100%;
      max-width: 400px;
    }

    .login-title {
      font-size: 28px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-subtitle {
      color: #94a3b8;
      margin-bottom: 30px;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #fca5a5;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  
  <!-- React -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Configuration - UPDATE THESE VALUES
    const API_URL = 'https://tracki-backend.onrender.com'; // Your backend URL (NO trailing slash)
    const ADMIN_PASSWORD = 'Aakash2y'; // Your admin password

    function App() {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [loginError, setLoginError] = useState('');
      const [devices, setDevices] = useState([]);
      const [selectedDevice, setSelectedDevice] = useState(null);
      const [isConnected, setIsConnected] = useState(false);
      const [showRenameModal, setShowRenameModal] = useState(false);
      const [newDeviceName, setNewDeviceName] = useState('');
      const [password, setPassword] = useState('');
      
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const markersRef = useRef({});
      const socketRef = useRef(null);

      // Login handler
      const handleLogin = (e) => {
        e.preventDefault();
        if (password === ADMIN_PASSWORD) {
          localStorage.setItem('tracki_admin_token', password);
          setIsAuthenticated(true);
          setLoginError('');
        } else {
          setLoginError('Invalid password');
        }
      };

      // Check authentication on mount
      useEffect(() => {
        const token = localStorage.getItem('tracki_admin_token');
        if (token === ADMIN_PASSWORD) {
          setIsAuthenticated(true);
        }
      }, []);

      // Initialize map and Socket.IO
      useEffect(() => {
        if (!isAuthenticated) return;

        // Initialize Leaflet map
        if (!mapInstanceRef.current && mapRef.current) {
          const map = L.map('map').setView([20.5937, 78.9629], 5); // India center
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
          }).addTo(map);
          
          mapInstanceRef.current = map;
        }

        // Initialize Socket.IO
        const socket = io(API_URL);
        socketRef.current = socket;

        socket.on('connect', () => {
          console.log('Connected to server');
          setIsConnected(true);
          socket.emit('GET_DEVICES');
        });

        socket.on('disconnect', () => {
          console.log('Disconnected from server');
          setIsConnected(false);
        });

        socket.on('DEVICES_LIST', (data) => {
          console.log('Received devices list:', data);
          setDevices(data.devices);
          
          // Update map with locations
          data.locations.forEach(loc => {
            updateMarker(loc);
          });
        });

        socket.on('LOCATION_UPDATE', (data) => {
          console.log('Location update:', data);
          updateMarker(data);
          
          // Update device in list
          setDevices(prev => {
            const updated = [...prev];
            const index = updated.findIndex(d => d.deviceId === data.deviceId);
            if (index !== -1) {
              updated[index] = {
                ...updated[index],
                deviceName: data.deviceName,
                lastSeen: new Date()
              };
            }
            return updated;
          });
        });

        socket.on('DEVICE_RENAMED', (data) => {
          console.log('Device renamed:', data);
          setDevices(prev => {
            const updated = [...prev];
            const index = updated.findIndex(d => d.deviceId === data.deviceId);
            if (index !== -1) {
              updated[index].deviceName = data.deviceName;
            }
            return updated;
          });
          
          // Update marker label
          if (markersRef.current[data.deviceId]) {
            markersRef.current[data.deviceId].setPopupContent(
              `<b>${data.deviceName}</b><br>${data.deviceId}`
            );
          }
        });

        // Fetch devices from API
        fetchDevices();

        return () => {
          socket.disconnect();
        };
      }, [isAuthenticated]);

      const updateMarker = (location) => {
        if (!mapInstanceRef.current) return;

        const { deviceId, deviceName, lat, lon } = location;
        
        if (markersRef.current[deviceId]) {
          // Update existing marker
          markersRef.current[deviceId].setLatLng([lat, lon]);
          markersRef.current[deviceId].setPopupContent(
            `<div style="min-width: 200px;">
              <b style="font-size: 14px;">${deviceName}</b><br>
              <span style="font-size: 11px; color: #666;">${deviceId}</span><br>
              <span style="font-size: 12px;">üìç ${lat.toFixed(6)}, ${lon.toFixed(6)}</span><br>
              <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                 style="display: inline-block; margin-top: 8px; padding: 6px 12px; background: #4285f4; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">
                üó∫Ô∏è Open in Google Maps
              </a>
            </div>`
          );
        } else {
          // Create new marker
          const marker = L.marker([lat, lon], {
            icon: L.divIcon({
              className: 'custom-marker',
              html: `<div style="background: #6366f1; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
              iconSize: [30, 30],
              iconAnchor: [15, 15]
            })
          }).addTo(mapInstanceRef.current);
          
          marker.bindPopup(
            `<div style="min-width: 200px;">
              <b style="font-size: 14px;">${deviceName}</b><br>
              <span style="font-size: 11px; color: #666;">${deviceId}</span><br>
              <span style="font-size: 12px;">üìç ${lat.toFixed(6)}, ${lon.toFixed(6)}</span><br>
              <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                 style="display: inline-block; margin-top: 8px; padding: 6px 12px; background: #4285f4; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">
                üó∫Ô∏è Open in Google Maps
              </a>
            </div>`
          );
          markersRef.current[deviceId] = marker;
        }
      };

      const fetchDevices = async () => {
        try {
          const response = await fetch(`${API_URL}/api/devices`, {
            headers: {
              'Authorization': `Bearer ${ADMIN_PASSWORD}`
            }
          });
          const data = await response.json();
          setDevices(data.devices);
          
          // Update markers
          data.devices.forEach(device => {
            if (device.lastLocation) {
              updateMarker({
                deviceId: device.deviceId,
                deviceName: device.deviceName,
                lat: device.lastLocation.lat,
                lon: device.lastLocation.lon
              });
            }
          });
        } catch (error) {
          console.error('Error fetching devices:', error);
        }
      };

      const handleRenameDevice = async () => {
        if (!selectedDevice || !newDeviceName.trim()) return;

        try {
          const response = await fetch(`${API_URL}/api/rename-device`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${ADMIN_PASSWORD}`
            },
            body: JSON.stringify({
              deviceId: selectedDevice.deviceId,
              deviceName: newDeviceName.trim()
            })
          });

          if (response.ok) {
            setShowRenameModal(false);
            setNewDeviceName('');
            setSelectedDevice(null);
          }
        } catch (error) {
          console.error('Error renaming device:', error);
        }
      };

      const handleDeviceClick = (device) => {
        setSelectedDevice(device);
        
        // Zoom to device on map
        if (device.lastLocation && mapInstanceRef.current) {
          mapInstanceRef.current.setView(
            [device.lastLocation.lat, device.lastLocation.lon],
            15
          );
          
          if (markersRef.current[device.deviceId]) {
            markersRef.current[device.deviceId].openPopup();
          }
        }
      };

      const openRenameModal = (device) => {
        setSelectedDevice(device);
        setNewDeviceName(device.deviceName);
        setShowRenameModal(true);
      };

      const getDeviceStatus = (lastSeen) => {
        if (!lastSeen) return 'offline';
        const diff = Date.now() - new Date(lastSeen).getTime();
        return diff < 60000 ? 'online' : 'offline'; // Online if seen in last 60 seconds
      };

      const formatLastSeen = (lastSeen) => {
        if (!lastSeen) return 'Never';
        const diff = Date.now() - new Date(lastSeen).getTime();
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        return `${Math.floor(hours / 24)}d ago`;
      };

      // Login screen
      if (!isAuthenticated) {
        return (
          <div className="login-container">
            <div className="login-box">
              <h1 className="login-title">Tracki Admin</h1>
              <p className="login-subtitle">Enter password to access dashboard</p>
              
              {loginError && (
                <div className="error-message">{loginError}</div>
              )}
              
              <form onSubmit={handleLogin}>
                <div className="form-group">
                  <label className="form-label">Password</label>
                  <input
                    type="password"
                    className="form-input"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="Enter admin password"
                    autoFocus
                  />
                </div>
                <button type="submit" className="btn btn-primary" style={{width: '100%', padding: '12px'}}>
                  Login
                </button>
              </form>
            </div>
          </div>
        );
      }

      const onlineDevices = devices.filter(d => getDeviceStatus(d.lastSeen) === 'online').length;

      return (
        <div className="container">
          <div className="sidebar">
            <div className="header">
              <h1>Tracki Admin</h1>
              <p>Live Location Tracking</p>
            </div>
            
            <div className="stats">
              <div className="stat">
                <div className="stat-value">{devices.length}</div>
                <div className="stat-label">Total Devices</div>
              </div>
              <div className="stat">
                <div className="stat-value">{onlineDevices}</div>
                <div className="stat-label">Online Now</div>
              </div>
            </div>
            
            <div className="device-list">
              {devices.map(device => (
                <div
                  key={device.deviceId}
                  className={`device-item ${selectedDevice?.deviceId === device.deviceId ? 'active' : ''}`}
                  onClick={() => handleDeviceClick(device)}
                >
                  <div className="device-name">{device.deviceName}</div>
                  <div className="device-id">{device.deviceId}</div>
                  <div className="device-status">
                    <span className={`status-dot ${getDeviceStatus(device.lastSeen)}`}></span>
                    {formatLastSeen(device.lastSeen)}
                  </div>
                  {device.lastLocation && (
                    <div style={{marginTop: '8px', fontSize: '11px', color: '#94a3b8', fontFamily: 'monospace'}}>
                      üìç {device.lastLocation.lat.toFixed(6)}, {device.lastLocation.lon.toFixed(6)}
                    </div>
                  )}
                  <div className="device-actions">
                    <button
                      className="btn btn-primary"
                      onClick={(e) => {
                        e.stopPropagation();
                        openRenameModal(device);
                      }}
                    >
                      Rename
                    </button>
                    {device.lastLocation && (
                      <button
                        className="btn btn-secondary"
                        onClick={(e) => {
                          e.stopPropagation();
                          const { lat, lon } = device.lastLocation;
                          window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank');
                        }}
                        title="Open in Google Maps"
                      >
                        üìç Maps
                      </button>
                    )}
                  </div>
                </div>
              ))}
              
              {devices.length === 0 && (
                <div style={{textAlign: 'center', padding: '40px', color: '#64748b'}}>
                  No devices registered yet
                </div>
              )}
            </div>
          </div>
          
          <div className="map-container">
            <div className="connection-status">
              <span className={`status-dot ${isConnected ? 'online' : 'offline'}`}></span>
              {isConnected ? 'Connected' : 'Disconnected'}
            </div>
            <div id="map" ref={mapRef}></div>
          </div>

          {/* Rename Modal */}
          <div className={`modal ${showRenameModal ? 'active' : ''}`}>
            <div className="modal-content">
              <h2 className="modal-title">Rename Device</h2>
              <div className="form-group">
                <label className="form-label">Device Name</label>
                <input
                  type="text"
                  className="form-input"
                  value={newDeviceName}
                  onChange={(e) => setNewDeviceName(e.target.value)}
                  placeholder="Enter new name"
                  autoFocus
                />
              </div>
              <div className="modal-actions">
                <button
                  className="btn btn-secondary"
                  onClick={() => {
                    setShowRenameModal(false);
                    setNewDeviceName('');
                  }}
                >
                  Cancel
                </button>
                <button
                  className="btn btn-primary"
                  onClick={handleRenameDevice}
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
